{% load static %} {% load navigation_tags %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Statistic</title>
    {% include 'Components/favIconTag.html' %}
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="{% static 'plugins/fontawesome-free/css/all.min.css' %}"
    />
    <!-- Tempusdominus Bootstrap 4 -->
    <link
      rel="stylesheet"
      href="{% static 'plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}"
    />
    <!-- Select2 -->
    <link
      rel="stylesheet"
      href="{% static 'plugins/select2/css/select2.min.css' %}"
    />
    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="{% static 'plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}"
    />
    <link
      rel="stylesheet"
      href="{% static 'plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}"
    />
    <link
      rel="stylesheet"
      href="{% static 'plugins/datatables-buttons/css/buttons.bootstrap4.min.css' %}"
    />
    <!-- Theme style -->
    <link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css' %}" />
  </head>
  <body
    class="hold-transition sidebar-mini layout-fixed dark-mode sidebar-collapse"
  >
    {% include 'Components/header.html' %}
    <!-- sidebar -->
    {% include 'Components/sidebar.html' %}
    <div class="wrapper">
      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper mt-2">
        <section class="content">
          <div class="container-fluid">
            <div class="row">
              <div class="col-md-6">
                <div class="card card-success">
                  <div class="card-header">
                    <h3 class="card-title">
                      <i class="fas fa-table mr-1"></i> Statistic Total Table
                    </h3>

                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="collapse"
                      >
                        <i class="fas fa-minus"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="remove"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <table
                      id="example2"
                      class="table table-bordered table-striped"
                    >
                      <thead>
                        <tr>
                          <th scope="col">channel name</th>
                          <th scope="col">Total Profit(Percent)</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in stat_total %}
                        <tr>
                          <th>
                            <!-- name -->
                            {{item.post__channel__name}}
                          </th>
                          <th>
                            <!-- total_profit -->
                            {{item.total_profit|floatformat:2}}
                          </th>
                        </tr>
                        {% endfor %}
                      </tbody>
                      <tfoot>
                        <tr>
                          <th scope="col">channel name</th>
                          <th scope="col">Total Profit(Percent)</th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card card-purple">
                  <div class="card-header">
                    <h3 class="card-title">
                      <i class="fas fa-chess-knight mr-1"></i>
                      Profit% Total
                    </h3>

                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="collapse"
                      >
                        <i class="fas fa-minus"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="remove"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="chart">
                      <canvas
                        id="barChart2"
                        style="
                          min-height: 250px;
                          height: 250px;
                          max-height: 250px;
                          max-width: 100%;
                        "
                      ></canvas>
                    </div>
                  </div>
                  <!-- /.card-body -->
                </div>
              </div>

              <div class="col-md-12">
                <div class="card card-fuchsia">
                  <div class="card-header">
                    <h3 class="card-title">
                      <i class="fas fa-table mr-1"></i>Channel Rank
                    </h3>

                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="collapse"
                      >
                        <i class="fas fa-minus"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="remove"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <table
                      id="example3"
                      class="table table-bordered table-striped"
                    >
                      <thead>
                        <tr>
                          <th scope="col">Rank</th>
                          <th scope="col">Channel name</th>
                          <th scope="col">Total Count</th>
                          <th scope="col">Failed Count</th>
                          <th scope="col">Success Count</th>
                          <th scope="col">Win Rate</th>
                          <th scope="col">Loss Rate</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in channel_predict_result_final %}
                        <tr>
                          <th>
                            <!-- index -->
                            {{ forloop.counter }}
                          </th>
                          <th>
                            <!-- name -->
                            {{item.name}}
                          </th>
                          <th>
                            <!-- total_count-->
                            {{item.total_count}}
                          </th>
                          <th>
                            <!-- FAILED_GROUP-->
                            {{item.FAILED_GROUP}}
                          </th>
                          <th>
                            <!-- SUCCESS_GROUP -->
                            {{item.SUCCESS_GROUP}}
                          </th>
                          <th>
                            <!-- Win Rate -->
                            {{item.win_rate|floatformat:2}}
                          </th>
                          <th>
                            <!-- Loss Rate -->
                            {{item.loss_rate|floatformat:2}}
                          </th>
                        </tr>
                        {% endfor %}
                      </tbody>
                      <tfoot>
                        <tr>
                          <th scope="col">Rank</th>
                          <th scope="col">Channel name</th>
                          <th scope="col">Total Count</th>
                          <th scope="col">Failed Count</th>
                          <th scope="col">Success Count</th>
                          <th scope="col">Win Rate</th>
                          <th scope="col">Loss Rate</th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>

              <div class="col-md-12">
                <div class="card card-orange">
                  <div class="card-header">
                    <h3 class="card-title">
                      <i class="fas fa-table mr-1"></i> Statistic Per Month
                      Table
                    </h3>

                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="collapse"
                      >
                        <i class="fas fa-minus"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="remove"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <table
                      id="example1"
                      class="table table-bordered table-striped"
                    >
                      <thead>
                        <tr>
                          <th scope="col">channel name</th>
                          <th scope="col">Date(Month)</th>
                          <th scope="col">Total Profit(Percent)</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in stat_per_month %}
                        <tr>
                          <th>
                            <!-- name -->
                            {{item.post__channel__name}}
                          </th>
                          <th>
                            <!-- month-->
                            {{item.month|date:"F Y"}}
                          </th>
                          <th>
                            <!-- total_profit -->
                            {{item.total_profit|floatformat:2}}
                          </th>
                        </tr>
                        {% endfor %}
                      </tbody>
                      <tfoot>
                        <tr>
                          <th scope="col">channel name</th>
                          <th scope="col">Date(Month)</th>
                          <th scope="col">Total Profit(Percent)</th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>

              <div class="col-md-12">
                <div class="card card-yellow">
                  <div class="card-header">
                    <h3 class="card-title">
                      <i class="fas fa-chess-knight mr-1"></i>
                      Profit% Per Month
                    </h3>

                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="collapse"
                      >
                        <i class="fas fa-minus"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="remove"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="chart">
                      <canvas
                        id="barChart1"
                        style="
                          min-height: 250px;
                          height: 250px;
                          max-height: 250px;
                          max-width: 100%;
                        "
                      ></canvas>
                    </div>
                  </div>
                  <!-- /.card-body -->
                </div>
              </div>
            </div>
          </div>
        </section>
        <!-- /.content -->
      </div>
    </div>
    <!-- ./wrapper -->

    <!-- jQuery -->
    <script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
    <!-- Bootstrap 4 -->
    <script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <!-- Bootstrap Switch -->
    <script src="{% static 'plugins/bootstrap-switch/js/bootstrap-switch.min.js' %}"></script>
    <!-- AdminLTE App -->
    <script src="{% static 'dist/js/adminlte.min.js' %}"></script>
    <!-- AdminLTE for demo purposes -->
    <script src="{% static 'dist/js/demo.js' %}"></script>
    <!-- Page specific script -->
    <!-- <script src="{% static 'plugins/moment/moment.min.js' %}"></script> -->
    <!-- Tempusdominus Bootstrap 4 -->
    <script src="{% static 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
    <!-- Select2 -->
    <script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>
    <!-- ChartJS -->
    <script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
    <script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>
    <script src="{% static 'plugins/jszip/jszip.min.js' %}"></script>
    <script src="{% static 'plugins/pdfmake/pdfmake.min.js' %}"></script>
    <script src="{% static 'plugins/pdfmake/vfs_fonts.js' %}"></script>
    <script src="{% static 'plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/gh/emn178/chartjs-plugin-labels/src/chartjs-plugin-labels.js"></script>
    <script>
      $(document).ready(function () {
        loadChannelStatPerMonthChart(
          `/panel/chart/channel-stat-per-month-chart`
        );
        loadChannelStatTotalChart(`/panel/chart/channel-stat-total-chart`);
      });
      $(function () {
        //Initialize Select2 Elements
        $(".select2").select2();

        //Initialize Select2 Elements
        $(".select2bs4").select2({
          theme: "bootstrap4",
        });
        //Date picker
        $("#dateFrom").datetimepicker({
          // defaultDate: "11/1/2013",
          format: "L",
        });
        $("#dateTo").datetimepicker({
          format: "L",
        });
      });
      $(function () {
        $("#example1")
          .DataTable({
            responsive: true,
            lengthChange: false,
            autoWidth: false,
            buttons: ["copy", "csv", "excel", "pdf", "print", "colvis"],
            // ordering: false,
            // search: {
            //   search: "12",
            // },
            // order: [[1, "asc"]],
          })
          .buttons()
          .container()
          .appendTo("#example1_wrapper .col-md-6:eq(0)");
        $("#example2")
          .DataTable({
            responsive: true,
            lengthChange: false,
            autoWidth: false,
            searching: false,
            // ordering: false,
            // search: {
            //   search: "12",
            // },
            // order: [[1, "asc"]],
          })
          .buttons()
          .container()
          .appendTo("#example3_wrapper .col-md-6:eq(0)");
        $("#example3")
          .DataTable({
            responsive: true,
            lengthChange: false,
            autoWidth: false,
            searching: false,
            ordering: false,
            order: [[5, "asc"]],
          })
          .buttons()
          .container()
          .appendTo("#example3_wrapper .col-md-6:eq(0)");
      });

      function loadChannelStatTotalChart(endpoint) {
        $.ajax({
          url: endpoint,
          type: "GET",
          dataType: "json",
          success: (jsonResponse) => {
            // Process data to structure it for the chart
            const labels = [
              ...new Set(jsonResponse.map((item) => item.post__channel__name)),
            ]; // Extract unique channel names
            const dataValues = jsonResponse.map((item) =>
              Math.round(item.total_profit)
            ); // Get total profit values and round them

            // Chart data
            const areaChartData = {
              labels: labels,
              datasets: [
                {
                  label: "Total Profit",
                  backgroundColor: "#fa931aaf",
                  borderColor: "#fa931a",
                  pointRadius: false,
                  data: dataValues,
                },
              ],
            };

            // Chart options
            const barChartCanvas = $("#barChart2").get(0).getContext("2d");
            const barChartOptions = {
              responsive: true,
              maintainAspectRatio: false,
              datasetFill: false,
              legend: {
                labels: {
                  fontColor: "#fff",
                },
              },
              plugins: {
                labels: {
                  render: "value",
                  showZero: true,
                  fontSize: 12,
                  fontColor: "#fff",
                },
              },
              scales: {
                xAxes: [
                  {
                    ticks: {
                      fontColor: "#fff",
                    },
                    gridLines: {
                      color: "#ffffff61",
                    },
                  },
                ],
                yAxes: [
                  {
                    ticks: {
                      fontColor: "#fff",
                    },
                    gridLines: {
                      color: "#ffffff61",
                      zeroLineColor: "#ff0000", // High contrast color for y=0 line
                      zeroLineWidth: 2,
                    },
                  },
                ],
              },
            };

            // Create the chart
            new Chart(barChartCanvas, {
              type: "bar",
              data: areaChartData,
              options: barChartOptions,
            });
          },
          error: () =>
            console.log("Failed to fetch chart data from " + endpoint + "!"),
        });
      }

      function loadChannelStatPerMonthChart(endpoint) {
        $.ajax({
          url: endpoint,
          type: "GET",
          dataType: "json",
          success: (jsonResponse) => {
            // Process data to structure it for the chart
            const labels = [
              ...new Set(
                jsonResponse.map((item) =>
                  new Intl.DateTimeFormat("en", {
                    year: "numeric",
                    month: "short",
                  }).format(new Date(item.month))
                )
              ),
            ]; // Extract unique months
            const channels = [
              ...new Set(jsonResponse.map((item) => item.post__channel__name)),
            ]; // Extract unique channels

            const datasets = channels.map((channelName) => {
              const channelData = jsonResponse
                .filter((item) => item.post__channel__name === channelName)
                .map((item) => Math.round(item.total_profit));

              return {
                label: channelName,
                backgroundColor: getRandomColor(), // Dynamic color for each channel
                borderColor: getRandomColor(),
                pointRadius: false,
                data: channelData,
              };
            });
            let maxLength = 0;

            datasets.forEach((item) => {
              if (item.data.length > maxLength) {
                maxLength = item.data.length;
              }
            });

            const newDataSets = datasets.map((item) => {
              const amount = maxLength - item.data.length;
              let newData = [];
              for (let i = 0; i < amount; i++) {
                newData.push(0);
              }
              newData = [...newData, ...item.data];
              return {
                ...item,
                data: newData,
              };
            });

            // Chart data
            const areaChartData = {
              labels: labels,
              datasets: newDataSets,
            };

            // Chart options
            const barChartCanvas = $("#barChart1").get(0).getContext("2d");
            const barChartOptions = {
              responsive: true,
              maintainAspectRatio: false,
              datasetFill: false,
              legend: {
                labels: {
                  fontColor: "#fff",
                },
              },
              plugins: {
                labels: {
                  render: "value",
                  showZero: true,
                  fontSize: 12,
                  fontColor: "#fff",
                },
              },
              scales: {
                xAxes: [
                  {
                    ticks: {
                      fontColor: "#fff",
                    },
                    gridLines: {
                      color: "#ffffff61",
                    },
                  },
                ],
                yAxes: [
                  {
                    ticks: {
                      fontColor: "#fff",
                    },
                    gridLines: {
                      color: "#ffffff61",
                      zeroLineColor: "#ff0000", // High contrast color for y=0 line
                      zeroLineWidth: 2,
                    },
                  },
                ],
              },
            };

            // Create the chart
            new Chart(barChartCanvas, {
              type: "bar",
              data: areaChartData,
              options: barChartOptions,
            });
          },
          error: () =>
            console.log("Failed to fetch chart data from " + endpoint + "!"),
        });
      }

      function getRandomColor() {
        const letters = "0123456789ABCDEF";
        let color = "#";
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }
    </script>
  </body>
</html>
